<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Minigolf Pálya Viewer - v1.4.0</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/exporters/GLTFExporter.js"></script>

    <!-- Moduláris struktúra -->
    <script src="constants.js"></script>
    <script src="hole-generator.js"></script>
    <script src="element-manager.js"></script>
    <script src="model.js"></script>
    <script src="geometry-builder.js"></script>
    <script src="exploder.js"></script>
    <script src="scene-manager.js"></script>
    <script src="view-mode.js"></script>
    <script src="summary.js"></script>

    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div id="viewer-container">
      <!-- Fő vezérlők -->
      <div id="controls">
        <button id="toggle-explode">Szétszedés</button>
        <button id="toggle-view-mode">Színes</button>
        <button id="export-gltf">GLTF Export</button>
      </div>

      <!-- Új nézet váltó gombok -->
      <div id="view-controls">
        <div class="view-label">Nézetek:</div>
        <button id="view-top">Felül</button>
        <button id="view-bottom">Alul</button>
        <button id="view-front">Elöl</button>
        <button id="view-back">Hátul</button>
        <button id="view-left">Bal</button>
        <button id="view-right">Jobb</button>
        <hr />
        <button id="zoom-in">Zoom +</button>
        <button id="zoom-out">Zoom -</button>
        <hr />
        <button id="reset-view">Alaphelyzet</button>
      </div>
    </div>
    <div id="summary-panel">
      <h1>Minigolf Pálya Specifikáció</h1>
      <!-- A summary javascript-ből lesz feltöltve -->
    </div>

    <script>
      // Globális változók
      let elementManager;
      let sceneManager;
      let geometryBuilder;
      let exploder;
      let viewModeManager;
      let allMeshes;

      // Inicializálás
      function initialize() {
        try {
          console.log("Inicializálás kezdete v1.4.0...");

          // Manager objektumok létrehozása
          elementManager = new ElementManager();
          sceneManager = new SceneManager(
            document.getElementById("viewer-container")
          );
          geometryBuilder = new GeometryBuilder();
          exploder = new Exploder();
          viewModeManager = new ViewModeManager(sceneManager, geometryBuilder);

          console.log("Manager objektumok létrehozva");

          // Scene setup
          sceneManager.setup();
          console.log("Scene setup kész");

          // Elemek betöltése
          minigolfElements.forEach((element) => {
            elementManager.addElement(element);
          });
          console.log(`${minigolfElements.length} elem betöltve`);

          // Mesh-ek létrehozása
          const elements = elementManager.getAllElements();
          allMeshes = geometryBuilder.createAllMeshes(elements);
          console.log(`${allMeshes.size} mesh létrehozva`);

          // Mesh-ek hozzáadása a scene-hez
          sceneManager.addAllMeshes(allMeshes);
          console.log("Mesh-ek hozzáadva a scene-hez");

          // ViewModeManager inicializálása - ELŐSZÖR mentjük az eredeti anyagokat
          viewModeManager.saveOriginalMaterials(allMeshes);
          console.log("Eredeti anyagok mentve");

          // Exploder inicializálása
          exploder.saveOriginalPositions(allMeshes);
          exploder.setViewModeManager(viewModeManager);
          console.log("Eredeti pozíciók mentve");

          // Alapértelmezett tervrajz nézet beállítása - FORCE módon
          viewModeManager.switchToBlueprint(
            allMeshes,
            elementManager.getAllElements(),
            true
          );
          console.log("Tervrajz nézet beállítva alapértelmezettként");

          // Summary generálása
          const summary = elementManager.generateSummary();
          const summaryPanel = document.getElementById("summary-panel");
          summaryGenerator.renderFullSummary(
            summaryPanel,
            summary,
            elementManager.version
          );
          console.log("Summary generálva");

          // Event listener-ek beállítása
          setupEventListeners();
          console.log("Event listener-ek beállítva");

          console.log("Inicializálás sikeres v1.4.0!");
        } catch (error) {
          console.error("Hiba az inicializálás során:", error);
        }
      }

      // Event listener-ek beállítása
      function setupEventListeners() {
        // Szétszedés gomb
        document
          .getElementById("toggle-explode")
          .addEventListener("click", function () {
            exploder.toggle(allMeshes, elementManager.getAllElements());

            // Gomb szöveg frissítése
            this.textContent = exploder.getState().isExploded
              ? "Összerakás"
              : "Szétszedés";
          });

        // Nézet váltás gomb
        document
          .getElementById("toggle-view-mode")
          .addEventListener("click", function () {
            viewModeManager.toggle(allMeshes, elementManager.getAllElements());

            // Gomb szöveg frissítése
            const newMode =
              viewModeManager.getCurrentMode() === "realistic"
                ? "Tervrajz"
                : "Színes";
            this.textContent = newMode;
          });

        // Alaphelyzet gomb
        document
          .getElementById("reset-view")
          .addEventListener("click", function () {
            // Exploded állapot visszaállítása
            if (exploder.getState().isExploded) {
              exploder.reset(allMeshes);
              document.getElementById("toggle-explode").textContent =
                "Szétszedés";
            }

            // Nézet visszaállítása (kamera pozíció)
            sceneManager.resetView();
          });

        // Zoom In gomb
        document
          .getElementById("zoom-in")
          .addEventListener("click", function () {
            sceneManager.zoomCamera(-50); // Negatív érték = közelebb
          });

        // Zoom Out gomb
        document
          .getElementById("zoom-out")
          .addEventListener("click", function () {
            sceneManager.zoomCamera(50); // Pozitív érték = távolabb
          });

        // GLTF export gomb
        document
          .getElementById("export-gltf")
          .addEventListener("click", function () {
            exportGLTF(false);
          });

        // ÚJ: Nézet váltó gombok
        document
          .getElementById("view-top")
          .addEventListener("click", function () {
            sceneManager.setTopView();
          });

        document
          .getElementById("view-bottom")
          .addEventListener("click", function () {
            sceneManager.setBottomView();
          });

        document
          .getElementById("view-front")
          .addEventListener("click", function () {
            sceneManager.setFrontView();
          });

        document
          .getElementById("view-back")
          .addEventListener("click", function () {
            sceneManager.setBackView();
          });

        document
          .getElementById("view-left")
          .addEventListener("click", function () {
            sceneManager.setLeftView();
          });

        document
          .getElementById("view-right")
          .addEventListener("click", function () {
            sceneManager.setRightView();
          });
      }

      // GLTF exportálási funkció
      async function exportGLTF(binary = false) {
        try {
          // Ha szétszedett állapotban van, átmenetileg állítsuk vissza
          const wasExploded = exploder.getState().isExploded;
          if (wasExploded) {
            exploder.setPositionImmediate(
              allMeshes,
              elementManager.getAllElements(),
              false
            );
          }

          // Export
          const result = await sceneManager.exportScene(binary);

          // Fájl mentése
          const filename = binary
            ? "minigolf_palya.glb"
            : "minigolf_palya.gltf";

          if (binary) {
            saveArrayBuffer(result, filename);
          } else {
            saveString(JSON.stringify(result, null, 2), filename);
          }

          // Ha szétszedett állapotban volt, állítsuk vissza
          if (wasExploded) {
            exploder.setPositionImmediate(
              allMeshes,
              elementManager.getAllElements(),
              true
            );
          }

          console.log(`Export sikeres: ${filename}`);
        } catch (error) {
          console.error("Export hiba:", error);
        }
      }

      // Segédfüggvények a fájlok mentéséhez
      function saveString(text, filename) {
        const blob = new Blob([text], { type: "text/plain" });
        downloadBlob(blob, filename);
      }

      function saveArrayBuffer(buffer, filename) {
        const blob = new Blob([buffer], { type: "application/octet-stream" });
        downloadBlob(blob, filename);
      }

      function downloadBlob(blob, filename) {
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();

        // Cleanup
        setTimeout(() => URL.revokeObjectURL(link.href), 1000);
      }

      // Debug funkciók (fejlesztéshez)
      function debugInfo() {
        console.log("=== DEBUG INFO v1.4.0 ===");
        console.log(
          "Element Manager:",
          elementManager.getAllElements().length + " elem"
        );
        console.log("Scene Manager:", sceneManager.getSceneInfo());
        console.log("Exploder:", exploder.getState());
        console.log("Mesh-ek:", allMeshes.size);
        console.log("Súly:", elementManager.getTotalWeight().toFixed(2) + " g");
        console.log("==================");
      }

      // Globális hozzáférés debug-hoz
      window.debugInfo = debugInfo;
      window.elementManager = () => elementManager;
      window.sceneManager = () => sceneManager;

      // Egyedi elem láthatóság kapcsoló funkció
      window.toggleElementVisibility = function (elementId, isVisible) {
        console.log(`Elem láthatóság váltás: ${elementId} -> ${isVisible}`);

        // Elem keresése ID szerint
        const mesh = allMeshes.get(elementId);
        if (mesh) {
          mesh.visible = isVisible;

          // Ha blueprint módban vagyunk, az edge outline is kell
          if (viewModeManager.getCurrentMode() === "blueprint") {
            const edgeLines =
              viewModeManager.wireframeMaterials?.get(elementId);
            if (edgeLines) {
              edgeLines.visible = isVisible;
            }
          }

          // Render frissítés
          sceneManager.renderer.render(sceneManager.scene, sceneManager.camera);
        } else {
          console.warn(`Elem nem található: ${elementId}`);
        }
      };

      // Inicializálás indítása az oldal betöltése után
      document.addEventListener("DOMContentLoaded", initialize);
    </script>
  </body>
</html>
